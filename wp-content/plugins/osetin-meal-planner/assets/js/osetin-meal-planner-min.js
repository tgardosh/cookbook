!function($){"use strict";$(function(){function e(){$(".os-modal").length||$("body").append('<div class="os-modal-w"><div class="os-modal no-padding"></div><div class="os-meal-planner-fader"></div></div>');var e=$(".os-modal");return $("body").addClass("meal-planner-modal-active"),e}function a(){var e=!0;"yes"===$("#mealPlannerForm").data("changed")&&(e=confirm("Are you sure you want to close meal planner? Changes you made will not be saved.")),!0===e&&($(".os-modal-w").remove(),$("body").removeClass("meal-planner-modal-active"),$(document).unbind("keyup.meal_planner"))}function n(a){var n=e();n.fadeOut(300),$.ajax({type:"post",dataType:"json",url:ajaxurl,data:a,success:function(e){n.show(),"success"===e.status?(n.html(e.message),o()):n.html(e.message),$(".meal-planner-w .mpd-body").perfectScrollbar()}})}function t(){var e=[];return $(".meal-planner-w .mp-day").each(function(){var a={periods:[]};$(this).find(".mpd-period").each(function(){var e=$(this).find(".mpd-period-header").text(),n={name:e,recipes_ids:[]};$(this).find(".mpdp-recipe").each(function(){var e=$(this).data("post-id");n.recipes_ids.push(e)}),a.periods.push(n)}),e.push(a)}),e}function l(e){var a=e.prop("id"),n=e.data("position"),t=$(".meal-planner-w .mpd-legend .legend-protein").data("label"),l=$(".meal-planner-w .mpd-legend .legend-carbs").data("label"),i=$(".meal-planner-w .mpd-legend .legend-fat").data("label"),d=e.data("protein"),s=e.data("carbs"),o=e.data("fat"),p=d+s+o,c=p>0?Math.round(d/p*100):0,m=p>0?Math.round(s/p*100):0,u=p>0?Math.round(o/p*100):0,f={labels:[i,l,t],series:[{meta:i,value:u},{meta:l,value:m},{meta:t,value:c}]};r["day_"+n]=new Chartist.Pie("#"+a+" .mpd-chart",f,{showLabel:!1,plugins:[Chartist.plugins.tooltip({tooltipFnc:function(e,a){return e+": "+a+"%"}})]})}function i(e){var a=e.data("position"),n=0,t=0,l=0,i=0;e.find(".mpdp-recipe").each(function(){n+=$(this).data("calories"),t+=$(this).data("protein"),l+=$(this).data("fat"),i+=$(this).data("carbs")}),e.find(".mpd-calories strong").text(n),e.data("calories",n),void 0!==r["day_"+a]&&(r["day_"+a].data.series[0].value=l,r["day_"+a].data.series[1].value=i,r["day_"+a].data.series[2].value=t,r["day_"+a].update()),e.find(".mpd-legend-label.legend-carbs span").text(i+c),e.find(".mpd-legend-label.legend-fat span").text(l+c),e.find(".mpd-legend-label.legend-protein span").text(t+c)}function d(e){$("#mealPlannerForm").data("changed",e)}function s(e){p=dragula(e,{copy:function(e,a){return $(a).hasClass("recipe-holder")},copySortSource:!0}).on("drag",function(){}).on("drop",function(e){$(e).closest(".mpd-period, .recipe-holder").removeClass("empty");var a=$(e).closest(".mp-day");a.length&&i(a),d("yes")}).on("over",function(e,a){$(a).closest(".mpd-period, .recipe-holder").addClass("over")}).on("out",function(e,a,n){var t=$(n).closest(".mp-day");t.length&&i(t),$(a).closest(".mpd-period, .recipe-holder").removeClass("over");var l=$(n).closest(".mpd-period, .recipe-holder");l.length&&!l.find(".mpdp-recipe").length&&l.addClass("empty")})}function o(){var e=!!$(".os-modal-w").length;$(".meal-planner-w .mp-days-i").slick({variableWidth:!0,centerMode:e,infinite:!1,speed:200}),$(document).unbind("keyup.meal_planner"),$(document).on("keyup.meal_planner",function(e){27===e.keyCode&&a()}),$(".meal-plan-close").on("click",function(){a()}),c=$(".meal-planner-w").data("nutritions-measure"),$("#meal_plan_name").on("change",function(){d("yes")}),$("#mp_days_total").on("change",function(){var e=$(".meal-planner-w .mp-day").length,a=$(this).val();if(e>a){var n=$(".meal-planner-w .mp-day").slice(a),t=!0;if(n.find(".mpdp-recipe").length&&(t=confirm("Some of the days that you want to remove have recipes, are you sure you want to remove them?")),!0===t){n.remove();var i=$(".meal-planner-w .mp-days-i");i.slick("reinit"),i.slick("slickCurrentSlide")>a-1&&i.slick("slickGoTo",a-1),d("yes")}}if(e<a)for(var s=e+1;s<=a;s++){var o=$(".meal-planner-w .mp-day:last").clone().data("position",s).data("calories",0).data("protein",0).data("carbs",0).data("fat",0);o.find(".mpdp-recipe").remove(),o.find(".mpd-calories strong").text("0"),o.find(".mpd-period").addClass("empty"),o.find(".mpd-number span").text(s),o.prop("id","mpDay_"+s),o.find(".mpd-nutritions iframe").remove(),o.find(".mpd-chart").html(""),o.insertAfter(".mp-day:last"),o.find(".mpd-legend .mpd-legend-label span").text("0"+c),l($(".meal-planner-w .mp-day:last")),$(".meal-planner-w .mp-day:last .mpd-body").perfectScrollbar(),p.containers=$(".mpd-period-recipes, .recipe-holder").toArray(),$(".meal-planner-w .mp-days-i").slick("reinit"),d("yes")}}),$(".select_meal_plan_btn, .create_new_meal_plan_btn").on("click",function(){$(this).prop("disabled",!0);var e=$(this).data("post-id"),a=$(this).closest("form").find('input[name="nonce"]').val(),t="new";$(this).hasClass("select_meal_plan_btn")&&(t=$("#select_meal_plan_id").val()),n({action:"osetin_select_or_create_meal_plan",post_id:e,nonce:a,meal_plan_id:t})}),$("#mealPlanSelectorForm").on("submit",function(e){e.preventDefault()}),$("#mealPlannerForm").on("submit",function(e){e.preventDefault(),$(".mpp-save-btn").addClass("disabled").find("button").prop("disabled",!0);var a=t();return $("#meal_plan_data").val(JSON.stringify(a)),$.ajax({type:"post",url:$("#mealPlannerForm").attr("action"),data:$("#mealPlannerForm").serialize(),success:function(e){$(".mpp-save-btn").removeClass("disabled").find("button").prop("disabled",!1),"success"===e.status&&(d("no"),e.post_id&&$("#meal_plan_id").val(e.post_id))}}),!1}),$("body").on("click",".mpdp-close",function(){var e=$(this).closest(".mpd-period, .recipe-holder"),a=$(this).closest(".mp-day");return $(this).closest(".mpdp-recipe").remove(),e.find(".mpdp-recipe").length||e.addClass("empty"),d("yes"),a.length&&i(a),!1}),s($(".meal-planner-w .mpd-period-recipes, .recipe-holder").toArray()),"undefined"!=typeof Chartist&&$(".mp-day").length&&$(".meal-planner-w .mp-day").each(function(){l($(this))})}var r={},p,c="g";$(".single-osetin_meal_plan .meal-planner-w").length&&o(),$("body").on("click",".os-meal-planner-fader",function(){return a(),!1}),$(".trigger-add-to-meal-plan").on("click",function(){return n({action:"osetin_select_or_create_meal_plan",post_id:$(this).data("post-id"),nonce:$(this).data("nonce")}),!1}),$(".print-meal-plan").on("click",function(){var e=$(this),a=$(this).data("meal-plan-id"),n={action:"osetin_ajax_load_full_meal_plan",meal_plan_id:a},t=$(".meal-plans-list").length?$(".meal-plans-list").data("wait-label"):$(this).data("wait-label");return e.data("temp-label",e.text()).find("span").text(t),$.ajax({type:"post",dataType:"json",url:ajaxurl,data:n,success:function(a){$("body").addClass("print-meal-plan"),$(".all-wrapper").before(a.message),$(window).scrollTop(0),e.find("span").text(e.data("temp-label")),$(".cancel-print-meal-plan-trigger").on("click",function(){return $(window).scrollTop(0),$("body").removeClass("print-meal-plan"),$(".full-meal-plan-recipes").remove(),!1})}}),!1}),$(".edit-meal-plan").on("click",function(){return n({action:"osetin_ajax_load_meal_plan",meal_plan_id:$(this).closest(".meal-plan").data("meal-plan-id"),nonce:$(this).data("nonce")}),!1}),$(".delete-meal-plan").on("click",function(){if(!confirm($(".meal-plans-list").data("delete-label")))return!1;$(this).data("temp-label",$(this).text()).text($(".meal-plans-list").data("wait-label"));var e=$(this).closest(".meal-plan"),a=e.data("meal-plan-id"),n=$(this).data("nonce"),t={action:"osetin_ajax_delete_meal_plan",meal_plan_id:a,nonce:n};return $.ajax({type:"post",dataType:"json",url:ajaxurl,data:t,success:function(a){"success"===a.status?e.hide(300,function(){$(this).remove()}):e.closest("ul").prepend("<p>"+a.message+"</p>")}}),!1})})}(jQuery);